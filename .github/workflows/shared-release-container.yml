---
on:
  workflow_call:

permissions: {}

jobs:
  release-container:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Clean Actions Runner
        id: clean_actions_runner
        uses: ministryofjustice/github-actions/clean-actions-runner@db1a54895bf5fb975c60af47e5a3aab96505ca3e # v18.6.0
        with:
          confirm: true

      - name: Prepare Environment
        id: prepare_environment
        shell: bash
        run: |
          ecrRepositoryName=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]' | sed 's/_/-/g')
          export ecrRepositoryName
          echo "ECR_REPOSITORY_NAME=${ecrRepositoryName}" >>"${GITHUB_ENV}"

      - name: Install cosign
        id: install_cosign
        uses: sigstore/cosign-installer@c56c2d3e59e4281cc41dea2217323ba5694b171e # v3.8.0

      - name: Configure AWS Credentials
        id: configure_aws_credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          aws-region: eu-west-2
          role-to-assume: arn:aws:iam::509399598587:role/ecr-access

      - name: Log in to Amazon ECR
        id: ecr_login
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1

      - name: Fetch ECR Access Policy
        id: fetch_ecr_access_policy
        shell: bash
        run: |
          curl --silent --show-error --location https://raw.githubusercontent.com/ministryofjustice/analytical-platform-airflow-github-actions/refs/heads/main/assets/ecr-access-policy/ecr-access-policy.json --output ecr-access-policy.json

      - name: Create ECR Repository
        id: create_ecr_repository
        shell: bash
        env:
          REPOSITORY: ${{ env.ECR_REPOSITORY_NAME }}
        run: |
          if [[ "$(aws ecr describe-repositories --repository-names "${REPOSITORY}" 2>&1)" == *"RepositoryNotFoundException"* ]]; then
            echo "Repository not found, creating it"
            aws ecr create-repository \
              --repository-name "${REPOSITORY}" \
              --image-tag-mutability "IMMUTABLE" \
              --image-scanning-configuration "scanOnPush=true" \
              --encryption-configuration "encryptionType=KMS,kmsKey=alias/ecr/default"
          else
            echo "Repository exists"
          fi

          aws ecr set-repository-policy \
            --repository-name "${REPOSITORY}" \
            --policy-text file://ecr-access-policy.json

      - name: Build and Push
        id: build_and_push
        uses: docker/build-push-action@ca877d9245402d1537745e0e356eab47c3520991 # v6.13.0
        with:
          push: true
          tags: ${{ steps.ecr_login.outputs.registry }}/${{ env.ECR_REPOSITORY_NAME }}:${{ github.ref_name }}

      - name: Sign
        id: sign
        shell: bash
        env:
          REGISTRY: ${{ steps.ecr_login.outputs.registry }}
          REPOSITORY: ${{ env.ECR_REPOSITORY_NAME }}
          IMAGE_DIGEST: ${{ steps.build_and_push.outputs.digest }}
        run: |
          cosign sign --yes "${REGISTRY}/${REPOSITORY}@${IMAGE_DIGEST}"

      - name: Verify Signature
        id: cosign_verify
        shell: bash
        env:
          REGISTRY: ${{ steps.ecr_login.outputs.registry }}
          REPOSITORY: ${{ env.ECR_REPOSITORY_NAME }}
          IMAGE_DIGEST: ${{ steps.build_and_push.outputs.digest }}
        run: |
          cosign verify \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp="https://github\.com/ministryofjustice/analytical-platform-airflow-github-actions/\.github/workflows/shared-release-container\.yml.+" \
            "${REGISTRY}/${REPOSITORY}@${IMAGE_DIGEST}"
